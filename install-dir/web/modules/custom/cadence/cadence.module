<?php

/**
 * @file
 * Modal System module.
 */

use Drupal\Core\Render\Element;

/**
 * Implements hook_page_attachments().
 */
function cadence_page_attachments(array &$attachments) {
  // Log that hook is being called.
  \Drupal::logger('cadence')->debug('Modal System: hook_page_attachments() called');
  
  // Skip during maintenance mode or install operations.
  if (defined('MAINTENANCE_MODE')) {
    \Drupal::logger('cadence')->debug('Modal System: Skipped - maintenance mode');
    return;
  }

  // Skip on admin pages that might be doing cache operations.
  try {
    $route_match = \Drupal::routeMatch();
    $route_name = $route_match->getRouteName();
    if ($route_name && (
        strpos($route_name, 'system.performance') !== FALSE ||
        strpos($route_name, 'system.cache') !== FALSE
      )) {
      \Drupal::logger('cadence')->debug('Modal System: Skipped - cache operation route');
      return;
    }
  }
  catch (\Exception $e) {
    // If we can't check the route, continue anyway.
  }

  // Only attach if the service exists and entity type is available.
  if (!\Drupal::hasService('cadence.modal_service')) {
    \Drupal::logger('cadence')->debug('Modal System: Service not available');
    return;
  }

  try {
    // Log the current route for debugging.
    $route_match = \Drupal::routeMatch();
    $route_name = $route_match->getRouteName();
    \Drupal::logger('cadence')->debug('Modal System: Hook running on route @route', ['@route' => $route_name ?? 'NULL']);

    // Check if entity type exists before trying to use it.
    $entity_type_manager = \Drupal::entityTypeManager();
    if (!$entity_type_manager->hasDefinition('modal')) {
      \Drupal::logger('cadence')->debug('Modal System: Entity type "modal" not defined');
      return;
    }

    $modal_service = \Drupal::service('cadence.modal_service');
    $modals = $modal_service->getEnabledModals();

    \Drupal::logger('cadence')->debug('Modal System: Found @count enabled modal(s)', ['@count' => count($modals)]);

    // Check if any modal needs confetti.js.
    $needs_confetti = FALSE;
    if (!empty($modals)) {
      foreach ($modals as $modal) {
        if (isset($modal['styling']['decorative_effect']) && $modal['styling']['decorative_effect'] === 'confetti') {
          $needs_confetti = TRUE;
          break;
        }
      }
    }

    // Always attach library and settings, even if empty (for debugging).
    $attachments['#attached']['drupalSettings']['modalSystem'] = [
      'modals' => $modals,
    ];
    $attachments['#attached']['library'][] = 'cadence/modal.system';
    
    // Only attach confetti.js if at least one modal uses it.
    if ($needs_confetti) {
      $attachments['#attached']['library'][] = 'cadence/modal.confetti';
    }
    
    if (!empty($modals)) {
      \Drupal::logger('cadence')->debug('Modal System: Library attached successfully on route @route with @count modal(s)', [
        '@route' => $route_name ?? 'NULL',
        '@count' => count($modals),
      ]);
    }
    else {
      \Drupal::logger('cadence')->debug('Modal System: Library attached but no enabled modals found - attaching empty array for debugging');
    }
  }
  catch (\Exception $e) {
    // Service might not be available during uninstall or cache rebuild.
    // Log the error for debugging.
    \Drupal::logger('cadence')->error('Modal System: Exception - @message', ['@message' => $e->getMessage()]);
  }
  catch (\Throwable $e) {
    // Catch any other errors to prevent breaking cache operations.
    \Drupal::logger('cadence')->error('Modal System: Throwable - @message', ['@message' => $e->getMessage()]);
  }

  // Attach admin CSS on admin pages.
  try {
    $route_match = \Drupal::routeMatch();
    $route_name = $route_match->getRouteName();
    if ($route_name && (
        strpos($route_name, 'entity.modal') === 0 ||
        strpos($route_name, 'cadence') === 0
      )) {
      $attachments['#attached']['library'][] = 'cadence/admin';
    }
  }
  catch (\Exception $e) {
    // Silently fail for admin CSS attachment.
  }
}

/**
 * Implements hook_theme().
 */
function cadence_theme($existing, $type, $theme, $path) {
  return [
    'modal_analytics' => [
      'variables' => [
        'analytics_data' => [],
        'show_archived' => FALSE,
      ],
      'template' => 'modal-analytics',
    ],
    'modal_analytics_charts' => [
      'variables' => [],
      'template' => 'modal-analytics-charts',
    ],
  ];
}

/**
 * Implements hook_cron().
 */
function cadence_cron() {
  // Check for expired modals and disable them automatically.
  try {
    $storage = \Drupal::entityTypeManager()->getStorage('modal');
    $modals = $storage->loadMultiple();
    $current_date = date('Y-m-d', \Drupal::time()->getRequestTime());
    $disabled_count = 0;

    foreach ($modals as $modal) {
      // Only check enabled modals (skip already disabled ones).
      if (!$modal->status()) {
        continue;
      }

      // Check if modal has an end date that has passed.
      $visibility = $modal->getVisibility();
      $end_date = $visibility['end_date'] ?? NULL;

      if (!empty($end_date)) {
        // Convert timestamp to date string if needed.
        if (is_numeric($end_date)) {
          $end_date = date('Y-m-d', (int) $end_date);
        }

        // Check if end date has passed.
        if ($current_date > $end_date) {
          // Disable the modal.
          $modal->set('status', FALSE);
          $modal->save();
          $disabled_count++;

          \Drupal::logger('cadence')->info('Modal @id (@label) automatically disabled - end date (@end_date) has passed.', [
            '@id' => $modal->id(),
            '@label' => $modal->label(),
            '@end_date' => $end_date,
          ]);
        }
      }
    }

    if ($disabled_count > 0) {
      \Drupal::logger('cadence')->info('Automatically disabled @count expired modal(s) during cron run.', [
        '@count' => $disabled_count,
      ]);
    }
  }
  catch (\Exception $e) {
    \Drupal::logger('cadence')->error('Error checking for expired modals during cron: @message', [
      '@message' => $e->getMessage(),
    ]);
  }
}
