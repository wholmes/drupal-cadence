{#
/**
 * @file
 * Template for modal analytics page.
 */
#}
<div class="modal-analytics-page">
  <div class="modal-analytics-header">
    <h1>{{ 'Modal Analytics'|t }}</h1>
    <div class="modal-analytics-actions">
      <a href="{{ url('custom_plugin.modal.analytics', {}, {'query': show_archived ? {} : {'show_archived': '1'}}) }}" class="button">
        {{ show_archived ? 'Hide Archived'|t : 'Show Archived'|t }}
      </a>
      <a href="javascript:location.reload();" class="button" title="{{ 'Refresh analytics data'|t }}">üîÑ {{ 'Refresh'|t }}</a>
      <a href="{{ url('custom_plugin.modal.analytics.download') }}" class="button" title="{{ 'Download All Data (CSV)'|t }}">üìä {{ 'CSV'|t }}</a>
    </div>
  </div>

  {% if analytics_data is empty %}
    <p>{{ 'No analytics data available yet.'|t }}</p>
  {% else %}
    <div class="modal-analytics-table-wrapper">
      <table class="modal-analytics-table">
        <thead>
          <tr>
            <th>{{ 'Modal'|t }}</th>
            <th class="analytics-number">{{ 'Impressions'|t }}</th>
            <th class="analytics-number">{{ 'CTA 1 Clicks'|t }}</th>
            <th class="analytics-number">{{ 'CTA 2 Clicks'|t }}</th>
            <th class="analytics-number">{{ 'Form Submissions'|t }}</th>
            <th class="analytics-number" title="{{ 'Total interactions'|t }}">{{ 'Interactions'|t }}</th>
            <th class="analytics-number">{{ 'Conversion Rate'|t }}</th>
            <th class="analytics-number">{{ 'Dismissals'|t }}</th>
            <th class="analytics-number">{{ 'Last 30 Days'|t }}</th>
            <th class="analytics-actions">{{ 'Actions'|t }}</th>
          </tr>
        </thead>
        <tbody>
          {% for modal_id, data in analytics_data %}
            <tr class="{{ data.is_archived ? 'modal-analytics-archived' : '' }}">
              <td>
                <strong>{{ data.modal.label() }}{% if data.is_archived %} <span class="modal-archived-badge">{{ 'Archived'|t }}</span>{% endif %}</strong><br>
                <small>{{ data.modal.id() }}</small>
              </td>
              <td class="analytics-number">{{ data.impressions }}</td>
              <td class="analytics-number">{{ data.cta1_clicks }}</td>
              <td class="analytics-number">{{ data.cta2_clicks }}</td>
              <td class="analytics-number">{{ data.form_submissions }}</td>
              <td class="analytics-number"><strong>{{ data.total_interactions }}</strong></td>
              <td class="analytics-number">{{ data.conversion_rate }}%</td>
              <td class="analytics-number">{{ data.dismissals }}</td>
              <td class="analytics-number">{{ data.recent_impressions }}</td>
              <td class="analytics-actions">
                <a href="{{ url('entity.modal.edit_form', {'modal': modal_id}) }}" class="button button--small" title="{{ 'Edit'|t }}">‚úèÔ∏è</a>
                <a href="{{ url('entity.modal.delete_form', {'modal': modal_id}) }}" class="button button--small button--danger" title="{{ data.is_archived ? 'Restore'|t : 'Archive'|t }}">{{ data.is_archived ? 'üîÑ' : 'üì¶' }}</a>
                <a href="{{ url('custom_plugin.modal.analytics.download', {'modal_id': modal_id}) }}" class="button button--small" title="{{ 'Download CSV'|t }}">üìä</a>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {# Chart visualizations #}
    <div class="modal-analytics-charts">
      <h2>{{ 'Visualization'|t }}</h2>
      <div class="chart-container">
        <h3>{{ 'Impressions by Modal'|t }}</h3>
        <canvas id="impressions-chart"></canvas>
      </div>
      <div class="chart-container">
        <h3>{{ 'Conversion Rate by Modal'|t }}</h3>
        <canvas id="conversion-chart"></canvas>
      </div>
      <div class="chart-container">
        <h3>{{ 'CTA Performance Comparison'|t }}</h3>
        <canvas id="cta-comparison-chart"></canvas>
      </div>
    </div>
  {% endif %}

  {# Reset analytics data section - collapsible #}
  <details class="modal-analytics-reset-details">
    <summary class="modal-analytics-reset-summary">{{ 'Danger Zone: Reset Analytics Data'|t }}</summary>
    <div class="modal-analytics-reset-section">
      <p class="description">{{ 'This will permanently delete all analytics data for all modals. This action cannot be undone.'|t }}</p>
      <form method="post" action="{{ url('custom_plugin.modal.analytics.reset') }}" onsubmit="return confirmReset();">
        <button type="submit" class="button button--danger">{{ 'Reset All Analytics Data'|t }}</button>
      </form>
    </div>
  </details>
</div>

<script>
function confirmReset() {
  const confirmed = confirm('{{ 'Are you absolutely sure you want to delete ALL analytics data? This cannot be undone!'|t }}');
  if (confirmed) {
    return confirm('{{ 'Final warning: This will delete all impression, click, and submission data for ALL modals. Continue?'|t }}');
  }
  return false;
}
</script>
